---
import { getCollection } from 'astro:content'
import Navbar from '../components/Navbar.astro'
import Layout from './Layout.astro'

const allDocs = await getCollection('docs')
const { title, description } = Astro.props

// Group docs by category
const categories = {
  quickstart: {
    label: 'Getting Started',
    order: ['introduction', 'quickstart'],
  },
  reference: {
    label: 'Reference',
    order: ['configuration', 'api'],
  },
  packages: {
    label: 'Packages',
    order: [
      'packages/core',
      'packages/horizon',
      'packages/argos',
      'packages/talos',
      'packages/huginn',
      'packages/muninn',
      'packages/norns',
      'packages/furies',
      'packages/watchtower',
    ],
  },
  guides: {
    label: 'Guides',
    order: ['concepts', 'advanced', 'examples'],
  },
}

// Sort docs into categories
const categorizedDocs = Object.entries(categories)
  .map(([key, config]) => {
    const docs = config.order.map((slug) => allDocs.find((d) => d.slug === slug)).filter(Boolean)
    return { key, label: config.label, docs }
  })
  .filter((cat) => cat.docs.length > 0)
---

<Layout title={title} description={description}>
  <Navbar />
  <div class="container-custom flex-1 flex flex-col md:flex-row gap-8 py-8 w-full">
    <!-- Sidebar -->
    <aside class="w-full md:w-64 shrink-0">
      <nav class="sticky top-24 flex flex-col gap-4 overflow-auto max-h-[calc(100vh-6rem)]">
        {
          categorizedDocs.map((category) => (
            <div class="mb-4">
              <span
                class={
                  'text-xs font-bold text-text-muted mb-2 uppercase tracking-wider block px-3'
                }>
                {category.label}
              </span>
              <div class="flex flex-col">
                {category.docs.map((doc) => {
                  if (!doc) return null

                  const isActive = Astro.url.pathname.includes(doc.slug)
                  const isPackage = doc.slug.startsWith('packages/')
                  const displayName = isPackage ? doc.data.title : doc.data.title

                  return (
                    <a
                      href={`/docs/${doc.slug}`}
                      class={`px-3 py-2 rounded-sm text-sm transition-colors ${
                        isActive
                          ? 'bg-primary/10 text-primary border border-primary/20'
                          : 'text-text-muted hover:text-white hover:bg-surface-highlight'
                      }`}>
                      {displayName}
                    </a>
                  )
                })}
              </div>
            </div>
          ))
        }
      </nav>
    </aside>

    <!-- Content -->
    <main class="flex-1 min-w-0">
      <article class="prose prose-invert prose-green max-w-none">
        <slot />
      </article>
    </main>
  </div>
</Layout>
